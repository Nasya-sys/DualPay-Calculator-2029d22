<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DualPay Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --pink: #FFD1DC; --green: #228B22; }
        body { background-color: var(--pink); font-family: 'Montserrat', sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; margin: 0; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); border-radius: 40px; border: 1px solid white; box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 90%; max-width: 380px; padding: 2rem; }
        .input-main { background-color: var(--green) !important; color: white !important; border-radius: 15px 0 0 15px; }
        .btn-curr { background-color: #333; color: white; border-radius: 0 15px 15px 0; padding: 0 15px; font-weight: bold; }
        #installBtn { background-color: var(--green); color: white; width: 100%; padding: 18px; border-radius: 20px; font-weight: bold; margin-top: 20px; font-size: 1.2rem; box-shadow: 0 10px 20px rgba(34, 139, 34, 0.3); }
    </style>
</head>
<body>
    <main class="glass text-center">
        <h1 class="comfortaa text-[#228B22] text-2xl font-bold mb-6">DualPay Calculator</h1>
        
        <div class="mb-4 text-left">
            <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Сметка</label>
            <div class="flex h-14">
                <input type="number" id="bill" placeholder="0.00" class="w-full p-3 input-main outline-none font-bold text-2xl">
                <button onclick="changeBillCurr()" id="billBtn" class="btn-curr text-lg">BGN</button>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-6">
            <input type="number" id="pBgn" placeholder="Платено лв" class="p-4 rounded-xl border border-gray-200 outline-none text-center font-bold">
            <input type="number" id="pEur" placeholder="Платено €" class="p-4 rounded-xl border border-gray-200 outline-none text-center font-bold">
        </div>

        <div id="res" class="hidden bg-white/60 p-5 rounded-3xl border border-white mb-4">
            <div id="mainR" class="text-4xl font-bold text-[#228B22]">0.00 лв</div>
            <div id="subR" class="text-xs text-gray-500 font-bold uppercase mt-1">Ресто</div>
        </div>

        <button id="installBtn">ИНСТАЛИРАЙ СЕГА</button>
    </main>

    <script>
        const RATE = 1.95583;
        let bCurr = 'BGN';

        function changeBillCurr() { 
            bCurr = bCurr === 'BGN' ? 'EUR' : 'BGN'; 
            document.getElementById('billBtn').innerText = bCurr; 
            calc(); 
        }

        function calc() {
            const b = parseFloat(document.getElementById('bill').value)||0;
            const pL = parseFloat(document.getElementById('pBgn').value)||0;
            const pE = parseFloat(document.getElementById('pEur').value)||0;
            const bL = bCurr === 'EUR' ? b * RATE : b;
            const totalL = pL + (pE * RATE);
            const diffL = totalL - bL;

            if(b > 0 && totalL > 0 && diffL >= 0) {
                document.getElementById('res').classList.remove('hidden');
                document.getElementById('mainR').innerText = diffL.toFixed(2) + ' лв';
            } else {
                document.getElementById('res').classList.add('hidden');
            }
        }

        ['bill','pBgn','pEur'].forEach(id => document.getElementById(id).addEventListener('input', calc));

        // --- МАГИЯТА ЗА ИНСТАЛИРАНЕ ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log("Приложението е готово за инсталация.");
        });

        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('installBtn').style.display = 'none';
                }
                deferredPrompt = null;
            } else {
                // Ако браузърът се инати, показваме директен прозорец
                alert("ИНСТАЛАЦИЯ:\n1. Натисни трите точки горе вдясно (на Chrome).\n2. Избери 'Инсталиране на приложение' или 'Добави на началния екран'.");
            }
        });

        // Генериране на системен файл (Manifest) в движение
        const manifest = {
            name: "DualPay Calculator",
            short_name: "DualPay",
            start_url: ".",
            display: "standalone",
            background_color: "#FFD1DC",
            theme_color: "#228B22",
            icons: [{ src: "https://cdn-icons-png.flaticon.com/512/2489/2489756.png", sizes: "512x512", type: "image/png" }]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.querySelector('head').insertAdjacentHTML('beforeend', `<link rel="manifest" href="${manifestURL}">`);

        // Регистрация на Service Worker
        if ('serviceWorker' in navigator) {
            const swCode = `self.addEventListener('fetch', function(event) {});`;
            const swBlob = new Blob([swCode], {type: 'application/javascript'});
            const swUrl = URL.createObjectURL(swBlob);
            navigator.serviceWorker.register(swUrl);
        }
    </script>
</body>
</html>
